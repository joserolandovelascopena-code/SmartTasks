<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restablecer contraseña</title>
    <link rel="icon" href="../../assets/icons/icon.png" type="image/png" />
    <link rel="stylesheet" href="../../assets/css/resetPass.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
  </head>
  <body>
    <div class="container_loader">
      <div class="rederigir_login">
        <div class="conten_loader">
          <div class="loader"></div>
          <h3 id="mnj">Cargando...</h3>
        </div>
      </div>
    </div>

    <div class="conexion_recover">
      <div class="content_msg">
        <i class="fa-solid fa-wifi"></i><br />
        <samp>Conexión restablecida</samp>
      </div>
    </div>

    <div class="reset-card">
      <h2>Nueva contraseña</h2>
      <p>
        Crea una contraseña segura. Asegúrate de no reutilizar una anterior.
      </p>

      <form class="reset-form" onsubmit="return false;">
        <label>Nueva contraseña</label>
        <div class="reset-input">
          <i class="fa-solid fa-lock"></i>
          <input id="newPass" type="password" placeholder="Nueva contraseña" />
          <i class="fa-solid fa-eye-slash eye" data-target="newPass"></i>
        </div>

        <label>Confirmar contraseña</label>
        <div class="reset-input">
          <i class="fa-solid fa-lock"></i>
          <input
            id="confirmPass"
            type="password"
            placeholder="Confirmar contraseña"
          />
          <i class="fa-solid fa-eye-slash eye" data-target="confirmPass"></i>
        </div>

        <button id="updatePassBtn">Actualizar contraseña</button>

        <p id="msg"></p>
      </form>
    </div>

    <script type="module">
      import { supabaseClient } from "../../assets/js/supabase.js";
      import { updatePassword } from "../../assets/js/auth.js";

      const hash = window.location.hash;
      const params = new URLSearchParams(hash.substring(1));

      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");

      if (access_token && refresh_token) {
        const { error } = await supabaseClient.auth.setSession({
          access_token,
          refresh_token,
        });

        if (error) {
          console.error("Error setSession:", error.message);
        }
      }

      let wasOffline = false;
      const msg = document.getElementById("msg");
      const recover = document.querySelector(".conexion_recover");

      window.addEventListener("offline", () => {
        msg.textContent = "No hay conexión a internet";
        msg.classList.add("active");
        wasOffline = true;
      });

      window.addEventListener("online", () => {
        if (!wasOffline) return;
        msg.textContent = "";
        msg.classList.remove("active");
        recover.classList.add("active");
        setTimeout(() => recover.classList.remove("active"), 1500);
        wasOffline = false;
      });

      document.querySelectorAll(".eye").forEach((icon) => {
        icon.addEventListener("click", () => {
          const input = document.getElementById(icon.dataset.target);
          const isPass = input.type === "password";
          input.type = isPass ? "text" : "password";
          icon.classList.toggle("fa-eye", isPass);
          icon.classList.toggle("fa-eye-slash", !isPass);
        });
      });

      document.getElementById("updatePassBtn").onclick = async () => {
        const pass1 = document.getElementById("newPass").value;
        const pass2 = document.getElementById("confirmPass").value;

        if (!navigator.onLine) {
          msg.textContent = "No hay conexión a internet";
          msg.classList.add("active");
          return;
        }

        if (pass1 !== pass2) {
          msg.textContent = "Las contraseñas no coinciden";
          msg.classList.add("active");
          return;
        }
        try {
          await updatePassword(pass1);
          const textLoader = document.getElementById("mnj");
          document.querySelector(".container_loader").classList.add("show");
          setTimeout(() => {
            textLoader.textContent = "Contraseña actualizada. Redirigiendo...";
          }, 1000);
          setTimeout(() => {
            window.location.href = "./login.html";
          }, 2000);
        } catch (e) {
          msg.style.color = "#f87171";
          msg.textContent = e.message;
          msg.classList.add("active");
        }
      };
    </script>
  </body>
</html>
